<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Testing :: Pact Avro Plugin</title>
    <link rel="canonical" href="https://austek.github.io/pact-avro-plugin/pact-avro-plugin/0.0.1/testing.html">
    <link rel="prev" href="logging.html">
    <meta name="generator" content="Antora 3.1.2">
    <link rel="stylesheet" href="../../_/css/site.css">
    <script>var uiRootPath = '../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://austek.github.io/pact-avro-plugin">Pact Avro Plugin</a>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <input id="search-input" type="text" placeholder="Search the docs">
        </div>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Products</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Product A</a>
            <a class="navbar-item" href="#">Product B</a>
            <a class="navbar-item" href="#">Product C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Services</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Service A</a>
            <a class="navbar-item" href="#">Service B</a>
            <a class="navbar-item" href="#">Service C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="pact-avro-plugin" data-version="0.0.1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">Pact Avro Plugin</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="index.html">About</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="getting_started.html">Getting Started</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="logging.html">Logging</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="testing.html">Testing</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Pact Avro Plugin</span>
    <span class="version">0.0.1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="index.html">Pact Avro Plugin</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">0.0.1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Pact Avro Plugin</a></li>
    <li><a href="testing.html">Testing</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/austek/pact-avro-plugin/edit/HEAD/docs/modules/ROOT/pages/testing.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Testing</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>For an overview how asynchronous messages work with Pact, see <a href="https://docs.pact.io/getting_started/how_pact_works/#non-http-testing-message-pact">Non-HTTP testing (Message Pact)</a>.</p>
</div>
<div class="paragraph">
<p>In this scenario, a message provider writes a Protocol Buffer message to some one-way transport mechanism, like a message queue, and a consumer
then reads it. With this style of testing, the transport mechanism is abstracted away.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="consumer"><a class="anchor" href="#consumer"></a>Consumer</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The message consumer test is written using the Pact Message test DSL. The test DSL defines the expected message format,  and then the consumer is tested with an example message generated by the test framework.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="the-avro-test-configuration"><a class="anchor" href="#the-avro-test-configuration"></a>The Avro test configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The consumer tests need to get the plugin loaded and configure the expected messages to use in the test. This is done
using the <code>usingPlugin</code> (or <code>using_plugin</code>, depending on the language implementation) followed by the content for the test
in some type of map form.</p>
</div>
<div class="paragraph">
<p>For each field of the message that we want in the contract, we define an entry with the field name as the key and
a matching definition as the value. For documentation on the matching definition format, see <a href="https://github.com/pact-foundation/pact-plugins/blob/main/docs/matching-rule-definition-expressions.md">Matching Rule definition expressions</a>.</p>
</div>
<div class="paragraph">
<p>For example, for a JVM test (taken from <a href="https://developers.google.com/protocol-buffers/docs/javatutorial">Protocol Buffer Java examples</a>) we would use the PactBuilder class:</p>
</div>
<details>
<summary class="title">Example Avro schema</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-avroschema hljs" data-lang="avroschema">[
  {
    "namespace": "com.github.austek.example",
    "type": "record",
    "name": "Item",
    "fields": [
      {
        "name": "name",
        "type": "string"
      },
      {
        "name": "id",
        "type": "long"
      }
    ]
  },
  {
    "namespace": "com.github.austek.example",
    "type": "record",
    "name": "Order",
    "fields": [
      {
        "name": "id",
        "type": "long"
      },
      {
        "name": "names",
          "type": "string"
      },
      {
        "name": "enabled",
        "type": "boolean"
      },
      {
        "name": "height",
        "type": "float"
      },
      {
        "name": "width",
        "type": "double"
      },
      {
        "name": "status",
        "type": {
          "type": "enum",
          "name": "Status",
          "symbols": [
            "CREATED",
            "UPDATED",
            "DELETED"
          ],
          "default": "CREATED"
        }
      },
      {
        "name": "address",
        "type": {
          "type": "record",
          "name": "MailAddress",
          "fields": [
            {
              "name": "no",
              "type": "int"
            },
            {
              "name": "street",
              "type": "string"
            },
            {
              "name": "zipcode",
              "type": [
                "bytes",
                "null"
              ]
            }
          ]
        }
      },
      {
        "name": "items",
        "type": {
          "type": "array",
          "items": "com.github.austek.example.Item"
        }
      }
    ]
  }
]</code></pre>
</div>
</div>
</div>
</details>
<div class="listingblock">
<div class="title">Consumer configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">        return builder
                .usingPlugin("avro")
                .expectsToReceive("Order Created", "core/interaction/message")
                .with(Map.of(
                        "message.contents", Map.ofEntries(
                                Map.entry("pact:avro", schemasPath),
                                Map.entry("pact:record-name", "Order"),
                                Map.entry("pact:content-type", "avro/binary"),
                                Map.entry("id", "notEmpty('100')"),
                                Map.entry("names", "notEmpty('name-1')"),
                                Map.entry("enabled", "matching(boolean, true)"),
                                Map.entry("height", "matching(decimal, 15.8)"),
                                Map.entry("width", "matching(decimal, 1.8)"),
                                Map.entry("status", "matching(equalTo, 'CREATED')"),
                                Map.entry("address", Map.of(
                                        "no", "matching(integer, 121)",
                                        "street", "matching(equalTo, 'street name')"
                                )),
                                Map.entry("items", List.of(
                                        Map.of(
                                                "name", "notEmpty('Item-1')",
                                                "id", "notEmpty('1')"
                                        ),
                                        Map.of(
                                                "name", "notEmpty('Item-2')",
                                                "id", "notEmpty('2')"
                                        )
                                ))
                        )
                ))
                .toPact();</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Java example consumer test</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    @Test
    @PactTestFor(pactMethod = "configureRecordWithDependantRecord")
    void consumerRecordWithDependantRecord(V4Interaction.AsynchronousMessage message) throws IOException {
        MessageContents messageContents = message.getContents();
        List&lt;Order&gt; orders = arrayByteToAvroRecord(Order.class, messageContents.getContents().getValue());
        Order order = assertFirstOrder(orders);

        assertThat(messageContents.getContents().getContentType()).hasToString("avro/binary; record=Order");
        assertThat(messageContents.getContents().getContentTypeHint()).isEqualTo(ContentTypeHint.BINARY);

        Map&lt;String, MatchingRuleCategory&gt; ruleCategoryMap = ((MatchingRulesImpl) messageContents.getMatchingRules()).getRules();
        assertThat(ruleCategoryMap).hasSize(1);
        Map&lt;String, MatchingRuleGroup&gt; rules = ruleCategoryMap.get("body").getMatchingRules();
        List&lt;MatchingRule&gt; idRules = rules.get("$.id").getRules();
        assertThat(idRules).hasSize(1);
        assertThat(idRules.get(0)).extracting("name").isEqualTo("not-empty");
        List&lt;MatchingRule&gt; name0Rules = rules.get("$.names").getRules();
        assertThat(name0Rules).hasSize(1);
        assertThat(name0Rules.get(0)).extracting("name").isEqualTo("not-empty");

        assertDoesNotThrow(() -&gt; orderService.process(order));
    }

    private &lt;T&gt; List&lt;T&gt; arrayByteToAvroRecord(Class&lt;T&gt; c, byte[] bytes) throws IOException {
        SpecificDatumReader&lt;T&gt; datumReader = new SpecificDatumReader&lt;&gt;(c);
        List&lt;T&gt; records = new ArrayList&lt;&gt;();

        try (ByteArrayInputStream in = new ByteArrayInputStream(bytes)) {
            BinaryDecoder decoder = DecoderFactory.get().binaryDecoder(in, null);
            while (!decoder.isEnd()) records.add(datumReader.read(null, decoder));
        }

        return records;
    }</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="provider"><a class="anchor" href="#provider"></a>Provider</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The message provider is verified by getting it to generate a message, and then this is verified against the Pact file
from the consumer. There are two main ways of verifying the provider:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Write a test in the provider code base that can call the provider to generate the message.</p>
</li>
<li>
<p>Use an HTTP proxy server that can call the provider and return the generated message, and then use a Pact framework verifier to verify it.</p>
</li>
</ol>
</div>
<details>
<summary class="title">Java example provider test</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.github.austek.example.pulsar.avro;

import au.com.dius.pact.core.model.ContentTypeHint;
import au.com.dius.pact.core.model.Interaction;
import au.com.dius.pact.core.model.Pact;
import au.com.dius.pact.provider.MessageAndMetadata;
import au.com.dius.pact.provider.PactVerifyProvider;
import au.com.dius.pact.provider.junit5.MessageTestTarget;
import au.com.dius.pact.provider.junit5.PactVerificationContext;
import au.com.dius.pact.provider.junit5.PactVerificationInvocationContextProvider;
import au.com.dius.pact.provider.junitsupport.Provider;
import au.com.dius.pact.provider.junitsupport.loader.PactBroker;
import com.github.austek.example.Item;
import com.github.austek.example.MailAddress;
import com.github.austek.example.Order;
import com.github.austek.example.Status;
import org.apache.avro.io.BinaryEncoder;
import org.apache.avro.io.EncoderFactory;
import org.apache.avro.specific.SpecificDatumWriter;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.TestTemplate;
import org.junit.jupiter.api.extension.ExtendWith;

import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.util.List;
import java.util.Map;

@Provider("order-provider")
@PactBroker(url = "http://localhost:9292")
class PactPulsarProducerTest {
    private static final String AVRO_CONTENT_TYPE = "avro/binary; record=Order";
    private static final String KEY_CONTENT_TYPE = "contentType";
    private static final String KEY_CONTENT_TYPE_HINT = "contentTypeHint";
    private static final ContentTypeHint CONTENT_TYPE_HINT = ContentTypeHint.BINARY;

    @TestTemplate
    @ExtendWith(PactVerificationInvocationContextProvider.class)
    void testTemplate(Pact pact, Interaction interaction, PactVerificationContext context) {
        context.verifyInteraction();
    }

    @BeforeEach
    void setupTest(PactVerificationContext context) {
        context.setTarget(new MessageTestTarget());
    }

    @PactVerifyProvider("Order Created")
    public MessageAndMetadata orderCreatedEvent() throws IOException {
        Order order = new Order(
                100L,
                "name-1",
                true,
                15.8F,
                1.8D, Status.CREATED, new MailAddress(121, "street name", null),
                List.of(
                        new Item("Item-1", 1L),
                        new Item("Item-2", 2L)
                )
        );

        return new MessageAndMetadata(
                serialise(order),
                Map.of(
                        KEY_CONTENT_TYPE, AVRO_CONTENT_TYPE,
                        KEY_CONTENT_TYPE_HINT, CONTENT_TYPE_HINT
                )
        );
    }

    private byte[] serialise(Order record) throws IOException {
        SpecificDatumWriter&lt;Order&gt; writer = new SpecificDatumWriter&lt;&gt;(Order.class);
        try (ByteArrayOutputStream outputStream = new ByteArrayOutputStream()) {
            BinaryEncoder encoder = EncoderFactory.get().binaryEncoder(outputStream, null);
            writer.write(record, encoder);
            encoder.flush();
            return outputStream.toByteArray();
        }
    }
}</code></pre>
</div>
</div>
</div>
</details>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="logging.html">Logging</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script id="site-script" src="../../_/js/site.js" data-ui-root-path="../../_"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
<script src="../../_/js/vendor/lunr.js"></script>
<script src="../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../.." data-snippet-length="100" data-stylesheet="../../_/css/search.css"></script>
<script async src="../../search-index.js"></script>
  </body>
</html>
